package qrcoder

import (
	"bytes"
	"encoding/base64"
	"fmt"
	"image"
	"image/color"
	"image/png"

	p "image/color/palette"

	"github.com/skip2/go-qrcode"
	"github.com/srwiley/oksvg"
	"github.com/srwiley/rasterx"
)

// Dimension limits
const (
	MAX_SIZE int = 1 << 11
	MIN_SIZE int = 1 << 7
)

const logoBase64 = `PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiIHN0YW5kYWxvbmU9Im5vIj8+CjwhLS0gQ3JlYXRlZCB3aXRoIElua3NjYXBlIChodHRwOi8vd3d3Lmlua3NjYXBlLm9yZy8pIC0tPgoKPHN2ZwogICB3aWR0aD0iOTAwIgogICBoZWlnaHQ9IjkwMCIKICAgdmlld0JveD0iMCAwIDIzOC4xMjQ5OSAyMzguMTI1IgogICB2ZXJzaW9uPSIxLjEiCiAgIGlkPSJzdmc1IgogICBpbmtzY2FwZTp2ZXJzaW9uPSIxLjEgKGM2OGUyMmMzODcsIDIwMjEtMDUtMjMpIgogICBzb2RpcG9kaTpkb2NuYW1lPSJlbmpvZWkuc3ZnIgogICB4bWxuczppbmtzY2FwZT0iaHR0cDovL3d3dy5pbmtzY2FwZS5vcmcvbmFtZXNwYWNlcy9pbmtzY2FwZSIKICAgeG1sbnM6c29kaXBvZGk9Imh0dHA6Ly9zb2RpcG9kaS5zb3VyY2Vmb3JnZS5uZXQvRFREL3NvZGlwb2RpLTAuZHRkIgogICB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciCiAgIHhtbG5zOnN2Zz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPgogIDxzb2RpcG9kaTpuYW1lZHZpZXcKICAgICBpZD0ibmFtZWR2aWV3NyIKICAgICBwYWdlY29sb3I9IiNmZmZmZmYiCiAgICAgYm9yZGVyY29sb3I9IiM2NjY2NjYiCiAgICAgYm9yZGVyb3BhY2l0eT0iMS4wIgogICAgIGlua3NjYXBlOnBhZ2VzaGFkb3c9IjIiCiAgICAgaW5rc2NhcGU6cGFnZW9wYWNpdHk9IjAuMCIKICAgICBpbmtzY2FwZTpwYWdlY2hlY2tlcmJvYXJkPSIwIgogICAgIGlua3NjYXBlOmRvY3VtZW50LXVuaXRzPSJweCIKICAgICBzaG93Z3JpZD0iZmFsc2UiCiAgICAgd2lkdGg9IjkwMHB4IgogICAgIGlua3NjYXBlOnpvb209IjAuNTExMTExMTEiCiAgICAgaW5rc2NhcGU6Y3g9IjExNTIuMzkxMyIKICAgICBpbmtzY2FwZTpjeT0iNzYxLjA4Njk2IgogICAgIGlua3NjYXBlOndpbmRvdy13aWR0aD0iMTkyMCIKICAgICBpbmtzY2FwZTp3aW5kb3ctaGVpZ2h0PSIxMDU0IgogICAgIGlua3NjYXBlOndpbmRvdy14PSIxMzY2IgogICAgIGlua3NjYXBlOndpbmRvdy15PSIwIgogICAgIGlua3NjYXBlOndpbmRvdy1tYXhpbWl6ZWQ9IjEiCiAgICAgaW5rc2NhcGU6Y3VycmVudC1sYXllcj0ibGF5ZXIxIiAvPgogIDxkZWZzCiAgICAgaWQ9ImRlZnMyIiAvPgogIDxnCiAgICAgaW5rc2NhcGU6bGFiZWw9IkNhbWFkYSAxIgogICAgIGlua3NjYXBlOmdyb3VwbW9kZT0ibGF5ZXIiCiAgICAgaWQ9ImxheWVyMSI+CiAgICA8Y2lyY2xlCiAgICAgICBzdHlsZT0iZmlsbDojZmZmZmZmO3N0cm9rZS13aWR0aDowLjIwMTA3NyIKICAgICAgIGlkPSJwYXRoMTA0MCIKICAgICAgIGN4PSIxMTkuMDYyNSIKICAgICAgIGN5PSIxMTkuMDYyNSIKICAgICAgIGlua3NjYXBlOmV4cG9ydC1maWxlbmFtZT0iL2hvbWUvZW5ndXNlci9JbWFnZW5zL2Vuam9laS9lbmp1bG9nby5wbmciCiAgICAgICBpbmtzY2FwZTpleHBvcnQteGRwaT0iOTYiCiAgICAgICBpbmtzY2FwZTpleHBvcnQteWRwaT0iOTYiCiAgICAgICByPSIxMTkuMDYyNSIgLz4KICAgIDxwYXRoCiAgICAgICBkPSJtIDExMy4wOTIyMSwxOS41NTA3MDMgYyAtOS4xMjgxMiwwLjQ0OTc5MiAtMTcuMzAzNzQ0LDIuMDM3MjkyIC0yNi41NjQxNjQsNS4xNTkzNzUgLTI4Ljc2MDIsOS42NTcyOTIgLTUxLjgzMTg3LDMyLjg4NzcwNiAtNjEuNTY4NTQsNjIuMDE4MzMxIC0zLjkxNTgzLDExLjc0NzUwMyAtNS43MTUsMjQuODcwODMxIC00Ljk3NDE2LDM2LjQzMzEyMSAwLjM3MDQxLDUuOTAwMjEgMC40NDk3OSw2LjMyMzU0IDEuMTM3Nyw2Ljk1ODU0IDAuNTgyMDksMC41MjkxNyAxLjAwNTQyLDAuNTI5MTcgOTcuMzY2Njc0LDAuNTI5MTcgaCA5Ni44MTEwMyBsIDAuNjM1LC0wLjYzNSBjIDAuODk5NTksLTAuODk5NTkgMS4wMzE4OCwtMi41NCAxLjA1ODM0LC0xMS45MzI3MSAwLC04LjQ5MzEyIC0wLjA3OTQsLTkuNDQ1NjIgLTEuMzQ5MzgsLTE3LjA2NTYyIC0yLjUxMzU0LC0xNC45NzU0MTYgLTguOTQyOTEsLTI5Ljg5NzkxOCAtMTguMTc2ODgsLTQyLjIwMTA0MiAtMC44OTk1OCwtMS4xNjQxNjcgLTEuOTU3OTEsLTIuNTQgLTIuNDA3NywtMy4wNjkxNjYgLTAuNDQ5OCwtMC41MDI3MDkgLTEuMzQ5MzgsLTEuNTg3NSAtMi4wMTA4MywtMi4zODEyNSAtMi4xMTY2NywtMi41OTI5MTcgLTkuMDc1MjEsLTkuMzEzMzMzIC0xMi4zMDMxMywtMTEuOTA2MjQ5IC0xMi40MDg5NSwtMTAuMDAxMjUgLTI3LjExOTc5LC0xNy4wMTI3MDggLTQxLjgwNDE3LC0xOS45NDk1ODQgLTUuNTgyNywtMS4xMTEyNDkgLTUuOTAwMiwtMS4xMzc3MDcgLTEwLjA1NDE2LC0xLjU2MTA0MSAtNS4wOCwtMC41MDI3MDggLTEwLjg0NzkxLC0wLjY2MTQ1OCAtMTUuNzk1NjMsLTAuMzk2ODc1IHogbSAxMi4yMjM3Niw0Ni44MzEyNDggYyAyLjI3NTQxLDAuMjkxMDQyIDcuNTkzNTQsMS41MDgxMjUgOS43ODk1OCwyLjI0ODk1OCA5LjA3NTIxLDMuMDk1NjI1IDE4LjE1MDQxLDkuNDE5MTY3IDIzLjgzODk2LDE2LjY0MjI5IDMuMTIyMDgsMy45NDIyOTIgNi4wMDYwNCw4LjU3MjQ5OSA1LjY4ODU0LDkuMTAxNjY5IC0wLjE1ODc1LDAuMjM4MTI1IC05MS44ODk3OTQsMC4xODUyMDUgLTkyLjE1NDM3NCwtMC4wNTI5NSAtMC4zNDM5NiwtMC4zNzA0MSAxLjg1MjA4LC00LjEyNzQ5NyA0LjYzMDIsLTcuODU4MTI0IDIuOTg5OCwtNC4wMjE2NjUgMTAuMjY1ODQsLTEwLjYzNjI0OSAxMy44MTEyNSwtMTIuNTk0MTY1IDAuNTAyNzEsLTAuMjY0NTg0IDAuOTc4OTYsLTAuNTgyMDgzIDEuMDU4MzQsLTAuNjg3OTE3IDAuMDc5NCwtMC4xMDU4MzMgMS43MTk3OSwtMC45NTI1IDMuNjc3NzEsLTEuOTA0OTk5IDkuMzkyNzA0LC00LjU3NzI5MiAxOS4xMjkzNzQsLTYuMTY0NzkyIDI5LjY1OTc5NCwtNC44OTQ3OTIgeiIKICAgICAgIGlkPSJwYXRoMiIKICAgICAgIHN0eWxlPSJmaWxsOiM1MjJiMzI7ZmlsbC1vcGFjaXR5OjE7c3Ryb2tlLXdpZHRoOjAuMDI2NDU4NCIKICAgICAgIGlua3NjYXBlOmV4cG9ydC14ZHBpPSI5NiIKICAgICAgIGlua3NjYXBlOmV4cG9ydC15ZHBpPSI5NiIKICAgICAgIGlua3NjYXBlOmV4cG9ydC1maWxlbmFtZT0iL2hvbWUvZW5ndXNlci9JbWFnZW5zL2Vuam9laS9lbmp1bG9nby5wbmciIC8+CiAgICA8cGF0aAogICAgICAgZD0ibSA3MC44MTE3OTYsMTQ4LjY2NzM2IGMgLTAuMzcwNDIsMC4xNTg3NSAtMS4wODQ3OSwwLjUyOTE3IC0xLjU4NzUsMC44NzMxMyAtMC41MDI3LDAuMzQzOTUgLTIuNTEzNTQsMS41NjEwNCAtNC40NDUsMi42OTg3NCAtMS45MzE0NiwxLjE2NDE4IC0zLjgzNjQ1LDIuMjc1NDIgLTQuMjMzMzMsMi41MTM1NSAtMC4zOTY4NywwLjIzODEyIC0xLjQyODc1LDAuODczMTIgLTIuMzAxODcsMS4zNzU4MyAtMC44NzMxMywwLjUyOTE3IC0yLjI0ODk3LDEuMzQ5MzcgLTMuMDQyNzEsMS44NTIwOCAtMC43OTM3NSwwLjUwMjcxIC0yLjc1MTY3LDEuNjY2ODggLTQuMzY1NjMsMi41OTI5MyAtMS41ODc1LDAuODk5NTggLTIuOTYzMzMsMS43NDYyNCAtMy4wNDI3MSwxLjgyNTYyIC0wLjA3OTQsMC4xMDU4MyAtMC43OTM3NSwwLjUyOTE3IC0xLjU4NzQ5LDAuOTc4OTYgLTIuMjQ4OTcsMS4yNDM1NCAtOC40OTMxMyw1LjAwMDYyIC05LjU3NzkyLDUuNzY3OTEgLTEuNDAyMjksMC45Nzg5NiAtMS4zNDkzOCwxLjc3MjcxIDAuMjM4MTIsNC4wNDgxMyAxLjUwODEzLDIuMTQzMTIgNC4xMDEwNSw1LjY4ODU0IDQuMjg2MjUsNS44NzM3NCAwLjA3OTQsMC4wNzk0IDAuNjM1LDAuNzE0MzggMS4yMTcwOSwxLjQ1NTIxIDMuMTc0OTksNC4wMjE2NyAxMi40MDg5NiwxMy4wNDM5NiAxNS4zNzIyOSwxNS4wNTQ4IDAuNDc2MjUsMC4yOTEwMyAxLjcxOTc5LDEuMjE3MDggMi43NzgxMiwyLjAzNzI5IDEuMDg0NzksMC44MjAyMSAyLjMyODMzLDEuNzE5NzkgMi43NTE2NiwxLjk4NDM3IDAuNDQ5OCwwLjI2NDU5IDAuODQ2NjcsMC41NTU2MiAwLjkyNjA1LDAuNjYxNDYgMC4zMTc1LDAuMzcwNDEgNi40ODIyOSwzLjg4OTM4IDkuNTI1LDUuNDIzOTYgMy42Nzc3MSwxLjgyNTYzIDkuMTU0NTgsNC4yNTk3OSAxMC41ODMzMyw0LjY1NjY2IDAuNTAyNzEsMC4xMzIzIDEuMjk2NDYsMC40MjMzMyAxLjcxOTc5LDAuNjA4NTUgMi41NCwxLjA1ODMzIDEwLjEzMzU0LDMuMDQyNyAxNC43NjM3NjQsMy44MzY0NiAxLjc3MjcsMC4zMTc0OSAzLjUxODk1LDAuNjM0OTkgMy44ODkzNywwLjY4NzkxIDYuMDU4OTUsMS4wNTgzMyAxOS44OTY2NiwxLjA1ODMzIDI3Ljc4MTI1LC0wLjAyNjUgMy4wOTU2MiwtMC40MjMzMyAxMS4zMjQxNiwtMi4yMjI1IDEzLjg5MDYyLC0zLjA0MjcxIDUuNzQxNDYsLTEuODUyMDkgNy45MTEwNCwtMi42MTkzNyAxMC4xODY0NiwtMy42NTEyNSA1Ljk1MzEyLC0yLjY0NTg0IDEwLjc5NSwtNS4yMTIyOSAxNC44OTYwNCwtNy44ODQ1OSAxLjQyODc1LC0wLjkyNjA0IDIuNjk4NzUsLTEuNjkzMzIgMi44MzEwNCwtMS42OTMzMiAwLjE1ODc1LDAgMC4yNjQ1OCwtMC4wNzk0IDAuMjY0NTgsLTAuMjExNjggMCwtMC4xMDU4MyAwLjQ0OTc5LC0wLjQ3NjI1IDEuMDA1NDIsLTAuODQ2NjYgMS4yMTcwOCwtMC43OTM3NSA0LjI4NjI1LC0zLjE0ODU0IDQuODE1NDIsLTMuNzA0MTYgMC4yMTE2NiwtMC4yMTE2OCAwLjkyNjA0LC0wLjgyMDIyIDEuNTg3NSwtMS4zMjI5MiAzLjEyMjA4LC0yLjM4MTI1IDguNTE5NTgsLTcuODMxNjcgMTIuNTk0MTYsLTEyLjcgMy43ODM1NCwtNC41NTA4NCA2LjQ1NTg0LC04LjQ5MzEyIDYuNDU1ODQsLTkuNTUxNDYgMCwtMC44NzMxMiAtMC42MDg1NSwtMS4zNzU4MyAtMy44MzY0NiwtMy4yODA4MyAtMS40NTUyMSwtMC44NDY2NyAtMy4zNjAyMSwtMS45ODQzOCAtNC4yMzMzMywtMi41MTM1NCAtMS45ODQzOCwtMS4yNDM1NSAtNS4xODU4NCwtMy4xNDg1NSAtNi40NTU4NCwtMy44MzY0NiAtMC41MjkxNywtMC4yOTEwNCAtMS4wNTgzMywtMC42ODc5MiAtMS4xNjQxNiwtMC44NzMxMiAtMC4xMDU4NCwtMC4xNTg3NiAtMC4zMTc1MSwtMC4zMTc1MSAtMC40NDk4LC0wLjMxNzUxIC0wLjE1ODc0LDAgLTIuMTE2NjYsLTEuMTM3NyAtNC4zOTIwOCwtMi41MTM1NCAtMi4yNDg5NiwtMS4zNzU4MyAtNC4xODA0MiwtMi41MTM1NCAtNC4yNTk3OSwtMi41MTM1NCAtMC4xMDU4MywwIC0wLjU1NTYyLC0wLjI5MTA0IC0xLjAzMTg3LC0wLjY2MTQ2IC0wLjQ3NjI1LC0wLjM3MDQyIC0wLjkyNjA1LC0wLjY2MTQ2IC0wLjk3ODk2LC0wLjY2MTQ2IC0wLjA3OTQsMCAtMS45ODQzOCwtMS4xMzc3MSAtNC4yNTk3OSwtMi41NCAtMy4wMTYyNSwtMS44MjU2MiAtNC4zMzkxNywtMi40ODcwOCAtNC44NDE4OCwtMi40MzQxNyAtMC41NTU2MiwwLjA1MjkgLTEuMjE3MDksMC43NDA4NCAtMi45MTA0MSwyLjk2MzM0IC00LjczNjA1LDYuMjQ0MTcgLTExLjUwOTM4LDEyLjE5NzI5IC0xNi43NDgxMywxNC43NjM3NCAtMC4zNzA0MiwwLjE4NTIyIC0wLjcxNDM4LDAuMzk2ODggLTAuNzkzNzUsMC40NzYyNSAtMC4yOTEwNCwwLjMxNzUxIC00Ljc4ODk2LDIuNDA3NzEgLTYuODc5MTcsMy4xNzUwMSAtMS4yNDM1NCwwLjQ0OTc5IC0yLjQ4NzA4LDAuOTI2MDQgLTIuNzc4MTIsMS4wNTgzMyAtMC4yOTEwNSwwLjEzMjI5IC0xLjExMTI1LDAuMzcwNDIgLTEuODUyMDksMC41MjkxNiAtMC43MTQzNywwLjE1ODc2IC0xLjc5OTE3LDAuNDIzMzQgLTIuMzgxMjUsMC41NTU2MyAtMS4xOTA2MiwwLjI5MTA0IC0yLjg4Mzk1LDAuNjA4NTUgLTUuNDIzOTUsMS4wMDU0MiAtMi4yNDg5NiwwLjM3MDQxIC0xMS44MDA0MiwwLjM3MDQxIC0xNC4xNTUyMSwwIC0zLjY1MTI1LC0wLjU1NTYzIC00LjUyNDM3LC0wLjcxNDM4IC02LjA4NTQyLC0xLjE2NDE3IC0wLjg3MzEyLC0wLjI2NDU4IC0xLjg3ODU0LC0wLjUwMjcxIC0yLjI0ODk1LC0wLjU4MjA4IC0wLjM3MDQyLC0wLjA1MyAtMC44OTk1OSwtMC4yMTE2NyAtMS4xOTA2MywtMC4zNDM5NiAtMC4yOTEwNCwtMC4xMzIyOSAtMS41MzQ1OSwtMC42MDg1NCAtMi43NTE2NjQsLTEuMDU4MzMgLTUuMDI3MDksLTEuODc4NTQgLTEwLjIzOTM4LC00Ljg2ODMzIC0xNC43MTA4NCwtOC40NjY2NyAtMi4zMjgzMywtMS44NTIwOCAtNi4yMTc3MSwtNS40MjM5NiAtNi4yMTc3MSwtNS43MTUgMCwtMC4wNzk0IC0wLjIxMTY2LC0wLjM0Mzk1IC0wLjQ0OTc5LC0wLjU4MjA4IC0wLjg3MzEzLC0wLjg3MzEzIC00LjMxMjcxLC01LjMxODEzIC00LjMxMjcxLC01LjU4MjcxIDAsLTAuMjY0NTggLTEuMjcsLTEuMzQ5MzcgLTEuNTYxMDQsLTEuMzIyOTEgLTAuMDc5NCwwIC0wLjQ0OTc5LDAuMTMyMjkgLTAuODIwMjEsMC4yNjQ1NyB6IgogICAgICAgaWQ9InBhdGg0IgogICAgICAgc3R5bGU9ImZpbGw6I2UzNTg3OTtmaWxsLW9wYWNpdHk6MTtzdHJva2Utd2lkdGg6MC4wMjY0NTg0IgogICAgICAgaW5rc2NhcGU6ZXhwb3J0LXhkcGk9Ijk2IgogICAgICAgaW5rc2NhcGU6ZXhwb3J0LXlkcGk9Ijk2IgogICAgICAgaW5rc2NhcGU6ZXhwb3J0LWZpbGVuYW1lPSIvaG9tZS9lbmd1c2VyL0ltYWdlbnMvZW5qb2VpL2VuanVsb2dvLnBuZyIgLz4KICA8L2c+Cjwvc3ZnPgo=`

type CoderPNG struct {
	content string
	size    int
	UseLogo bool
}

func NewCoderPNG(content string, size int) *CoderPNG {

	if size > MAX_SIZE {
		size = MAX_SIZE
	}
	if size < MIN_SIZE {
		size = MIN_SIZE
	}

	return &CoderPNG{content: content, size: size}
}

func (cs CoderPNG) Encode() (raw []byte, err error) {
	code, err := qrcode.New(cs.content, qrcode.Highest)
	if err != nil {
		return raw, fmt.Errorf("PNG Encode: %w", err)
	}

	var buf bytes.Buffer
	img := code.Image(cs.size)

	if cs.UseLogo {
		cs.addLogo(img)
	}

	if err = png.Encode(&buf, img); err != nil {
		return raw, fmt.Errorf("PNG Encode: %w", err)
	}

	return buf.Bytes(), nil
}

func (cs CoderPNG) addLogo(qrcode image.Image) (err error) {

	//define color in image
	var palette = qrcode.(*image.Paletted)
	palette.Palette = color.Palette{
		color.RGBA{0xff, 0xff, 0xff, 0xff},
		color.RGBA{0x0, 0x0, 0x0, 0xff},
		color.RGBA{0x52, 0x2b, 0x32, 0xff},
		color.RGBA{0xe3, 0x58, 0x79, 0xff},
	}
	palette.Palette = append(palette.Palette, p.WebSafe...)

	logo, err := cs.readLogoFromCSV()

	// draw logo in qrcode
	offset := qrcode.Bounds().Max.X/2 - logo.Bounds().Max.X/2

	for x := 0; x < logo.Bounds().Max.X; x++ {
		for y := 0; y < logo.Bounds().Max.Y; y++ {
			if _, _, _, alpha := logo.At(x, y).RGBA(); alpha == 0 {
				continue
			}
			palette.Set(x+offset, y+offset, logo.At(x, y))
		}
	}

	return err
}

func (cs CoderPNG) readLogoFromCSV() (img image.Image, err error) {
	l, err := base64.StdEncoding.DecodeString(logoBase64)
	if err != nil {
		return
	}
	buf := bytes.NewBuffer(l)

	var size = cs.size / 6

	icon, err := oksvg.ReadIconStream(buf)
	if err != nil {
		return
	}

	icon.SetTarget(0, 0, float64(size), float64(size))
	rgba := image.NewRGBA(image.Rect(0, 0, size, size))
	scanner := rasterx.NewScannerGV(size, size, rgba, rgba.Bounds())
	dasher := rasterx.NewDasher(size, size, scanner)

	icon.Draw(dasher, 1)
	return rgba, err
}
